
name: Apply Auth0 Changes

on:
  push:
    branches: ["main", "master"]
    paths:
      - "apps/**/*.yaml"
      - "apps/**/*.yml"
      - "*.tf"
      - "**/*.tf"

permissions:
  contents: read

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  apply:
    runs-on: ubuntu-latest
    env:
      AUTH0_DOMAIN:        ${{ secrets.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID:     ${{ secrets.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
      TF_VAR_auth0_domain:        ${{ secrets.AUTH0_DOMAIN }}
      TF_VAR_auth0_client_id:     ${{ secrets.AUTH0_CLIENT_ID }}
      TF_VAR_auth0_client_secret: ${{ secrets.AUTH0_CLIENT_SECRET }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed app files
        id: pick
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $before = "${{ github.event.before }}"
          $after  = "${{ github.sha }}"
          if ([string]::IsNullOrWhiteSpace($before) -or $before -eq "0000000000000000000000000000000000000000") {
            $before = $(git rev-parse HEAD~1)
          }
          $changed = @(git diff --name-only $before $after |
            Where-Object { $_ -match '^apps\/.*\.ya?ml$' } |
            ForEach-Object { $_.Trim() } |
            Sort-Object -Unique)

          if ($changed.Count -eq 0) {
            Write-Host "No app YAML changes detected; nothing to apply."
            "changed_json=[]" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          } else {
            $json = "[" + (($changed | ForEach-Object { '"' + ($_ -replace '"','\"') + '"' }) -join ",") + "]"
            "changed_json=$json" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "Changed files:"; $changed | ForEach-Object { Write-Host " - $_" }
          }

      - uses: hashicorp/setup-terraform@v3

      - name: Build apps.auto.tfvars.json (PowerShell)
        shell: pwsh
        env:
          CHANGED_JSON: ${{ steps.pick.outputs.changed_json }}
        run: |
          $ErrorActionPreference = "Stop"
          try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
          Install-Module powershell-yaml -Scope CurrentUser -Force
          Import-Module powershell-yaml

          $paths = ConvertFrom-Json $env:CHANGED_JSON
          $apps  = @()
          foreach ($p in $paths) {
            $apps += (Get-Content $p -Raw | ConvertFrom-Yaml)
          }
          $tfvars = @{ apps = $apps }
          $json   = $tfvars | ConvertTo-Json -Depth 50
          Set-Content -Path "apps.auto.tfvars.json" -Value $json -Encoding UTF8
          Write-Host "Wrote apps.auto.tfvars.json with $($apps.Count) app(s)."

      - name: Terraform Init
        run: terraform init -input=false

      # -------- PRE-IMPORT: import connection_clients to bypass provider guard --------
      - name: Preflight import auth0_connection_clients
        id: preflight
        shell: pwsh
        env:
          MANAGED_CONNECTIONS: "CustomersDB,azure-ad-prod"  # Keep in sync with Terraform root main.tf
        run: |
          $ErrorActionPreference = "Stop"

          $paths = ConvertFrom-Json "${{ steps.pick.outputs.changed_json }}"
          if (-not $paths -or $paths.Count -eq 0) {
            Write-Host "No apps to process; skipping import."
            exit 0
          }

          # Get Management API token
          $aud = "https://$env:AUTH0_DOMAIN/api/v2/"
          $body = @{
            client_id     = $env:AUTH0_CLIENT_ID
            client_secret = $env:AUTH0_CLIENT_SECRET
            audience      = $aud
            grant_type    = "client_credentials"
          } | ConvertTo-Json
          $tokResp = Invoke-RestMethod -Method Post -Uri "https://$($env:AUTH0_DOMAIN)/oauth/token" `
            -ContentType "application/json" -Body $body
          $token = $tokResp.access_token
          if (-not $token) { throw "Failed to get Auth0 Management API token." }

          # Fetch all connections once
          $conns = Invoke-RestMethod -Method Get -Uri "https://$($env:AUTH0_DOMAIN)/api/v2/connections?per_page=1000&page=0" `
            -Headers @{ Authorization = "Bearer $token" }

          $managed = $env:MANAGED_CONNECTIONS -split ',' | ForEach-Object { $_.Trim() }

          # Import per app/env and per managed connection
          try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
          Install-Module powershell-yaml -Scope CurrentUser -Force
          Import-Module powershell-yaml

          foreach ($path in $paths) {
            $obj = (Get-Content $path -Raw) | ConvertFrom-Yaml
            $org = [string]$obj.orgname
            $app = [string]$obj.app
            $env = ([string]$obj.env).ToLower()
            $modKey = "$org/$app-$env"

            foreach ($name in $managed) {
              $conn = $conns | Where-Object { $_.name -eq $name }
              if (-not $conn) { throw "Managed connection '$name' not found in tenant." }
              $connId = $conn.id
              $addr   = "module.auth0_app[`"$modKey`"].auth0_connection_clients.managed[`"$name`"]"
              Write-Host "Importing $addr with connection ID $connId"
              terraform import "$addr" "$connId"
            }
          }

      - name: Terraform Plan (strict connections)
        id: tfplan
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Show Plan
        run: terraform show -no-color tfplan

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve tfplan

      # ---------- POST-APPLY ASSERTION ----------
      - name: Assert connections enabled only as requested
        shell: pwsh
        env:
          MANAGED_CONNECTIONS: "CustomersDB,azure-ad-prod"
        run: |
          $ErrorActionPreference = "Stop"

          $aud = "https://$env:AUTH0_DOMAIN/api/v2/"
          $body = @{
            client_id     = $env:AUTH0_CLIENT_ID
            client_secret = $env:AUTH0_CLIENT_SECRET
            audience      = $aud
            grant_type    = "client_credentials"
          } | ConvertTo-Json
          $tokResp = Invoke-RestMethod -Method Post -Uri "https://$($env:AUTH0_DOMAIN)/oauth/token" `
            -ContentType "application/json" -Body $body
          $token = $tokResp.access_token
          if (-not $token) { throw "Failed to get Auth0 token for assertion." }

          $paths   = ConvertFrom-Json "${{ steps.pick.outputs.changed_json }}"
          $managed = $env:MANAGED_CONNECTIONS -split ',' | ForEach-Object { $_.Trim() }

          try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
          Install-Module powershell-yaml -Scope CurrentUser -Force
          Import-Module powershell-yaml

          foreach ($path in $paths) {
            $obj      = (Get-Content $path -Raw) | ConvertFrom-Yaml
            $display  = [string]$obj.displayname
            $wanted   = @($obj.connections) | Sort-Object -Unique

            # Resolve client_id by name
            $clients  = Invoke-RestMethod -Method Get -Uri "https://$($env:AUTH0_DOMAIN)/api/v2/clients?per_page=1000" `
                          -Headers @{ Authorization = "Bearer $token" }
            $clientId = ($clients | Where-Object { $_.name -eq $display }).client_id
            if (-not $clientId) { throw "Client '$display' not found after apply." }

            $bad = $false
            foreach ($name in $managed) {
              $connList = Invoke-RestMethod -Method Get -Uri "https://$($env:AUTH0_DOMAIN)/api/v2/connections?per_page=1000&page=0" `
                           -Headers @{ Authorization = "Bearer $token" }
              $conn = $connList | Where-Object { $_.name -eq $name }
              if (-not $conn) { throw "Connection '$name' not found during assertion." }

              $enabled = @($conn.enabled_clients)
              $has     = ($enabled -contains $clientId)
              $should  = ($wanted -contains $name)

              if ($should -and (-not $has)) {
                Write-Host "❌ Expected ENABLED on '$name' but not found."
                $bad = $true
              }
              if ((-not $should) -and $has) {
                Write-Host "❌ Expected DISABLED on '$name' but client is enabled."
                $bad = $true
              }
            }

            if ($bad) { throw "Post-apply assertion failed for '$display'." }
            Write-Host "Post-apply assertion passed for '$display' ✅"
          }

      # ---------- FAILURE CLEANUP ----------
      - name: Cleanup client on failure (soft rollback)
        if: ${{ failure() }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $aud = "https://$env:AUTH0_DOMAIN/api/v2/"
          $body = @{
            client_id     = $env:AUTH0_CLIENT_ID
            client_secret = $env:AUTH0_CLIENT_SECRET
            audience      = $aud
            grant_type    = "client_credentials"
          } | ConvertTo-Json
          $tokResp = Invoke-RestMethod -Method Post -Uri "https://$($env:AUTH0_DOMAIN)/oauth/token" `
            -ContentType "application/json" -Body $body
          $token = $tokResp.access_token
          if (-not $token) { Write-Host "No token; skipping cleanup."; exit 0 }

          $paths = ConvertFrom-Json "${{ steps.pick.outputs.changed_json }}"
          if (-not $paths -or $paths.Count -eq 0) { Write-Host "No files; skip cleanup."; exit 0 }

          try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
          Install-Module powershell-yaml -Scope CurrentUser -Force
          Import-Module powershell-yaml

          foreach ($path in $paths) {
            $obj     = (Get-Content $path -Raw) | ConvertFrom-Yaml
            $display = [string]$obj.displayname
            $clients = Invoke-RestMethod -Method Get -Uri "https://$($env:AUTH0_DOMAIN)/api/v2/clients?per_page=1000" `
                        -Headers @{ Authorization = "Bearer $token" }
            $clientId = ($clients | Where-Object { $_.name -eq $display }).client_id
            if ($clientId) {
              Write-Host "Deleting client '$display' ($clientId) due to failure."
              Invoke-RestMethod -Method Delete -Uri "https://$($env:AUTH0_DOMAIN)/api/v2/clients/$clientId" `
                -Headers @{ Authorization = "Bearer $token" } -ErrorAction SilentlyContinue
            }
          }
