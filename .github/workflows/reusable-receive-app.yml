name: Reusable - Receive Auth0 App (Create PR)

on:
  workflow_call:
    inputs:
      org:        { required: true, type: string }
      app:        { required: true, type: string }
      env:        { required: true, type: string }
      yaml_path:  { required: true, type: string }
      yaml_b64:   { required: true, type: string }
      src_repo:   { required: true, type: string }
      src_sha:    { required: true, type: string }

    # âœ… REQUIRED: declare secrets used by reusable workflow
    secrets:
      AUTH0_GHAPP_ID:
        required: true
      AUTH0_GHAPP_PRIVATE_KEY:
        required: true

permissions:
  contents: read

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Sanity check secrets are available (safe)
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ secrets.AUTH0_GHAPP_ID }}")) {
            throw "AUTH0_GHAPP_ID is not available to this reusable workflow run."
          }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}")) {
            throw "AUTH0_GHAPP_PRIVATE_KEY is not available to this reusable workflow run."
          }
          Write-Host "Secrets are present."

      - name: Get GitHub App token (auth0-apps only)
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Checkout auth0-apps (with App token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Validate inputs (strict)
        shell: pwsh
        run: |
          $org  = "${{ inputs.org }}"
          $app  = "${{ inputs.app }}"
          $env  = "${{ inputs.env }}"
          $yp   = "${{ inputs.yaml_path }}"
          $repo = "${{ inputs.src_repo }}"
          $sha  = "${{ inputs.src_sha }}"

          if ($org  -notmatch '^[A-Za-z0-9._-]+$') { throw "bad org: $org" }
          if ($app  -notmatch '^[A-Za-z0-9._-]+$') { throw "bad app: $app" }
          if ($env  -notmatch '^(DEV|TEST|PROD)$')  { throw "bad env: $env" }
          if ($yp   -notmatch '^apps\/.*\.ya?ml$')  { throw "bad yaml_path: $yp" }
          if ($repo -notmatch '^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+$') { throw "bad src_repo: $repo" }
          if ($sha  -notmatch '^[0-9a-f]{7,40}$')   { throw "bad src_sha: $sha" }

      - name: Decode YAML to temp file
        shell: pwsh
        run: |
          $bytes = [Convert]::FromBase64String("${{ inputs.yaml_b64 }}")
          New-Item -ItemType Directory -Force -Path "tmp/appreq" | Out-Null
          [IO.File]::WriteAllBytes("tmp/appreq/app.yaml", $bytes)

          Write-Host "Decoded YAML (first 20 lines):"
          Get-Content "tmp/appreq/app.yaml" -TotalCount 20

      - name: Validate YAML schema (orgname/app/env)
        shell: pwsh
        run: |
          if (-not (Get-Command ConvertFrom-Yaml -ErrorAction SilentlyContinue)) {
            Install-Module powershell-yaml -Scope CurrentUser -Force
          }
          Import-Module powershell-yaml

          $y = Get-Content "tmp/appreq/app.yaml" -Raw | ConvertFrom-Yaml

          foreach ($k in @('orgname','app','env')) {
            if (-not $y.$k) { throw "Missing required key '$k' in YAML" }
          }

          if ([string]$y.env -notin @('DEV','TEST','PROD')) {
            throw "YAML env must be DEV|TEST|PROD, got '$($y.env)'"
          }

          # Optional: ensure request matches workflow inputs (prevents confusion)
          if ([string]$y.orgname -ne "${{ inputs.org }}") { throw "YAML orgname does not match inputs.org" }
          if ([string]$y.app     -ne "${{ inputs.app }}") { throw "YAML app does not match inputs.app" }
          if ([string]$y.env     -ne "${{ inputs.env }}") { throw "YAML env does not match inputs.env" }

      - name: Prepare branch and target
        id: prep
        shell: pwsh
        run: |
          $org = "${{ inputs.org }}"
          $app = "${{ inputs.app }}"
          $env = "${{ inputs.env }}".ToLower()

          $branch = "auto/$org-$app-$env-${{ github.run_id }}"
          $target = "apps/$org/$app-$env.yaml"

          "branch=$branch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "target=$target" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Commit and push branch (auth0-apps)
        shell: pwsh
        run: |
          $branch = "${{ steps.prep.outputs.branch }}"
          $target = "${{ steps.prep.outputs.target }}"

          git checkout -b $branch

          $dir = Split-Path -Parent $target
          New-Item -ItemType Directory -Force -Path $dir | Out-Null
          Copy-Item "tmp/appreq/app.yaml" $target -Force

          git config user.name "auth0-automation"
          git config user.email "auth0-automation@users.noreply.github.com"

          git add $target
          git commit -m "Auth0 app request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"
          git push origin $branch

      - name: Open PR (use GitHub App token)
        shell: pwsh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          $title = "Auth0 App Request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"
          $head  = "${{ steps.prep.outputs.branch }}"
          $base  = "master"

          $bodyLines = @(
            "Automated Auth0 app registration request.",
            "",
            "Source repo: ${{ inputs.src_repo }}",
            "Commit:      ${{ inputs.src_sha }}",
            "Source file: ${{ inputs.yaml_path }}",
            "",
            "Target file: ${{ steps.prep.outputs.target }}"
          )
          $body = $bodyLines -join "`n"

          $payload = @{
            title = $title
            head  = $head
            base  = $base
            body  = $body
          } | ConvertTo-Json -Depth 6

          Invoke-RestMethod `
            -Method POST `
            -Uri "https://api.github.com/repos/${{ github.repository }}/pulls" `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            } `
            -Body $payload
