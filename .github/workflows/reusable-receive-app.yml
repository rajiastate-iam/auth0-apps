name: Reusable - Receive Auth0 App (Create PR)

on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      app:
        required: true
        type: string
      env:
        required: true
        type: string
      src_repo:
        required: true
        type: string
      src_sha:
        required: true
        type: string
      src_file:
        required: true
        type: string
      artifact_name:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout auth0-apps repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        shell: pwsh
        run: |
          $srcRepo = "${{ inputs.src_repo }}"
          $srcSha  = "${{ inputs.src_sha }}"
          $srcFile = "${{ inputs.src_file }}"

          if ($srcRepo -notmatch '^rajiastate\/') { throw "src_repo not allowed: $srcRepo" }
          if ($srcSha -notmatch '^[0-9a-f]{7,40}$') { throw "src_sha invalid: $srcSha" }
          if ($srcFile -notmatch '^apps\/.*\.ya?ml$') { throw "src_file invalid: '$srcFile'" }

      - name: Download YAML artifact from caller run
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: /tmp/appreq

      - name: Verify YAML file exists
        shell: pwsh
        run: |
          $path = "/tmp/appreq/app.yaml"
          if (-not (Test-Path $path)) { throw "Expected artifact file missing: $path" }
          Write-Host "Artifact YAML (first 20 lines):"
          Get-Content $path -TotalCount 20

      # ---- Choose ONE auth method below ----

      - name: Get GitHub App token (preferred)
        id: app-token
        if: ${{ secrets.AUTH0_GHAPP_ID != '' && secrets.AUTH0_GHAPP_PRIVATE_KEY != '' }}
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Select token
        id: tok
        shell: pwsh
        run: |
          if ("${{ steps.app-token.outputs.token }}" -ne "") {
            "token=${{ steps.app-token.outputs.token }}" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "Using GitHub App token"
          } elseif ("${{ secrets.AUTH0_AUTOMATION_TOKEN }}" -ne "") {
            "token=${{ secrets.AUTH0_AUTOMATION_TOKEN }}" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
            Write-Host "Using fallback PAT token"
          } else {
            throw "No token available. Set AUTH0_GHAPP_ID+AUTH0_GHAPP_PRIVATE_KEY or AUTH0_AUTOMATION_TOKEN in auth0-apps secrets."
          }

      - name: Commit and push branch
        id: commit
        shell: pwsh
        run: |
          $org = "${{ inputs.org }}"
          $app = "${{ inputs.app }}"
          $envName = "${{ inputs.env }}"

          $branch = "auto/$org-$app-$envName-${{ github.run_id }}"
          $target = "apps/$org/$app-$envName.yaml"

          git checkout -b $branch
          New-Item -ItemType Directory -Force -Path "apps/$org" | Out-Null
          Copy-Item "/tmp/appreq/app.yaml" $target -Force

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add $target
          git commit -m "Auth0 app request: $org / $app / $envName"
          git push origin $branch

          "branch=$branch" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8
          "target=$target" | Out-File $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Open PR (using selected token)
        shell: pwsh
        env:
          GH_TOKEN: ${{ steps.tok.outputs.token }}
        run: |
          $title = "Auth0 App Request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"

          $body = @(
            "Automated Auth0 app registration request.",
            "",
            "Source repo: ${{ inputs.src_repo }}",
            "Commit:      ${{ inputs.src_sha }}",
            "Source file: ${{ inputs.src_file }}",
            "",
            "Target file: ${{ steps.commit.outputs.target }}"
          ) -join "`n"

          $payload = @{
            title = $title
            head  = "${{ steps.commit.outputs.branch }}"
            base  = "master"
            body  = $body
          } | ConvertTo-Json -Depth 6

          $uri = "https://api.github.com/repos/${{ github.repository }}/pulls"

          Invoke-RestMethod `
            -Method POST `
            -Uri $uri `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            } `
            -Body $payload
