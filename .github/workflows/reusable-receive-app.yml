name: Reusable - Receive Auth0 App (Create PR)

on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      app:
        required: true
        type: string
      env:
        required: true
        type: string
      yaml_path:
        required: true
        type: string
      yaml_b64:
        required: true
        type: string
      src_repo:
        required: true
        type: string
      src_sha:
        required: true
        type: string

# For reusable workflows, keep this minimal.
# We'll use the GitHub App token for actual writes.
permissions:
  contents: read

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Get GitHub App token (auth0-apps only)
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.AUTH0_GHAPP_ID }}
          private_key: ${{ secrets.AUTH0_GHAPP_PRIVATE_KEY }}

      - name: Checkout auth0-apps (with App token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Validate inputs (basic)
        shell: bash
        run: |
          set -euo pipefail

          org="${{ inputs.org }}"
          app="${{ inputs.app }}"
          env="${{ inputs.env }}"
          ypath="${{ inputs.yaml_path }}"
          repo="${{ inputs.src_repo }}"
          sha="${{ inputs.src_sha }}"

          [[ "$org" =~ ^[A-Za-z0-9._-]+$ ]] || (echo "bad org" && exit 1)
          [[ "$app" =~ ^[A-Za-z0-9._-]+$ ]] || (echo "bad app" && exit 1)
          [[ "$env" =~ ^[A-Za-z0-9._-]+$ ]] || (echo "bad env" && exit 1)
          [[ "$ypath" =~ ^apps/.*\.ya?ml$ ]] || (echo "bad yaml_path" && exit 1)
          [[ "$repo" =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]] || (echo "bad src_repo" && exit 1)
          [[ "$sha" =~ ^[0-9a-f]{7,40}$ ]] || (echo "bad src_sha" && exit 1)

      - name: Decode YAML into temp file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/appreq
          echo "${{ inputs.yaml_b64 }}" | base64 -d > /tmp/appreq/app.yaml
          echo "Decoded first 20 lines:"
          head -n 20 /tmp/appreq/app.yaml

      - name: Prepare branch + target path
        id: prep
        shell: bash
        run: |
          set -euo pipefail

          org="${{ inputs.org }}"
          app="${{ inputs.app }}"
          env="$(echo "${{ inputs.env }}" | tr '[:upper:]' '[:lower:]')"

          branch="auto/${org}-${app}-${env}-${{ github.run_id }}"
          target="apps/${org}/${app}-${env}.yaml"

          echo "branch=$branch" >> "$GITHUB_OUTPUT"
          echo "target=$target" >> "$GITHUB_OUTPUT"

      - name: Commit and push branch (auth0-apps)
        shell: bash
        run: |
          set -euo pipefail

          branch="${{ steps.prep.outputs.branch }}"
          target="${{ steps.prep.outputs.target }}"

          git checkout -b "$branch"
          mkdir -p "$(dirname "$target")"
          cp /tmp/appreq/app.yaml "$target"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$target"
          git commit -m "Auth0 app request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"
          git push origin "$branch"

      - name: Open PR (auth0-apps) using App token
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          title="Auth0 App Request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"
          head_branch="${{ steps.prep.outputs.branch }}"
          base_branch="master"

          # Build PR body safely (no YAML here-strings)
          body="Automated Auth0 app registration request.

Source repo: ${{ inputs.src_repo }}
Commit:      ${{ inputs.src_sha }}
Source file: ${{ inputs.yaml_path }}

Target file: ${{ steps.prep.outputs.target }}
"

          # Create JSON payload with jq to avoid quoting issues
          payload="$(jq -n \
            --arg title "$title" \
            --arg head "$head_branch" \
            --arg base "$base_branch" \
            --arg body "$body" \
            '{title:$title, head:$head, base:$base, body:$body}')"

          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "$payload"
