name: Reusable - Receive Auth0 App (Create PR)

on:
  workflow_call:
    inputs:
      org:
        required: true
        type: string
      app:
        required: true
        type: string
      env:
        required: true
        type: string

      src_repo:
        required: true
        type: string
      src_sha:
        required: true
        type: string
      yaml_path:
        required: true
        type: string

      yaml_b64:
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout auth0-apps
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs and decode YAML
        id: prep
        shell: pwsh
        run: |
          $org     = "${{ inputs.org }}"
          $app     = "${{ inputs.app }}"
          $envName = ("${{ inputs.env }}").ToLower()

          if ($envName -notmatch '^(dev|test|prod)$') { throw "env must be dev/test/prod. Got: $envName" }

          # Make safe for branch names
          $safeOrg = ($org -replace '[^A-Za-z0-9._-]', '-')
          $safeApp = ($app -replace '[^A-Za-z0-9._-]', '-')

          $branch = "auto/$safeOrg-$safeApp-$envName-${{ github.run_id }}"
          $target = "apps/$org/$app-$envName.yaml"

          New-Item -ItemType Directory -Force -Path "/tmp/appreq" | Out-Null

          $b64 = "${{ inputs.yaml_b64 }}"
          $bytes = [Convert]::FromBase64String($b64)
          $content = [Text.Encoding]::UTF8.GetString($bytes)

          $decoded = "/tmp/appreq/app.yaml"
          $content | Out-File -FilePath $decoded -Encoding utf8 -NoNewline

          Write-Host "Decoded YAML -> $decoded"
          Write-Host "First 25 lines:"
          Get-Content $decoded -TotalCount 25

          "branch=$branch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "target=$target" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "decoded=$decoded" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Commit and push branch
        id: commit
        shell: pwsh
        run: |
          $branch = "${{ steps.prep.outputs.branch }}"
          $target = "${{ steps.prep.outputs.target }}"
          $decoded = "${{ steps.prep.outputs.decoded }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b $branch

          $dir = Split-Path $target -Parent
          New-Item -ItemType Directory -Force -Path $dir | Out-Null

          Copy-Item $decoded $target -Force

          git add $target
          git commit -m "Auth0 app request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"
          git push origin $branch

          "branch=$branch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "target=$target" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Open PR
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $title = "Auth0 App Request: ${{ inputs.org }} / ${{ inputs.app }} / ${{ inputs.env }}"

          $body = @(
            "Automated Auth0 app registration request.",
            "",
            "Source repo: ${{ inputs.src_repo }}",
            "Commit:      ${{ inputs.src_sha }}",
            "Source file: ${{ inputs.yaml_path }}",
            "",
            "Target file: ${{ steps.commit.outputs.target }}"
          ) -join "`n"

          $payload = @{
            title = $title
            head  = "${{ steps.commit.outputs.branch }}"
            base  = "master"
            body  = $body
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod `
            -Method POST `
            -Uri "https://api.github.com/repos/${{ github.repository }}/pulls" `
            -Headers @{
              Authorization = "Bearer $env:GH_TOKEN"
              Accept        = "application/vnd.github+json"
              "User-Agent"  = "github-actions"
            } `
            -Body $payload

          Write-Host "PR request sent."
