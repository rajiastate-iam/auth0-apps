
- name: Validate app policy (PowerShell)
  shell: pwsh
  env:
    CHANGED_JSON: ${{ steps.pick.outputs.changed_json }}
  run: |
    $ErrorActionPreference = "Stop"

    try { Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction Stop } catch {}
    Install-Module powershell-yaml -Scope CurrentUser -Force
    Import-Module powershell-yaml

    $files = ConvertFrom-Json $env:CHANGED_JSON
    if (-not $files -or $files.Count -eq 0) {
      Write-Host "No app YAMLs changed; skipping validation."
      exit 0
    }

    $allowedConns = @("CustomersDB","azure-ad-prod")
    $errors = @()

    function Check-Urls($urls,$field) {
      foreach ($u in ($urls ?? @())) {
        try {
          $uri = [System.Uri]$u
          if ($uri.Scheme -ne "https") {
            $script:errors += "$($field): URL must use https -> $u"
          }
          $host = ($uri.Host ?? "").ToLower()
          if ($host -eq "localhost" -or $host -eq "127.0.0.1" -or $host.EndsWith(".local")) {
            $script:errors += "$($field): localhost/127.0.0.1/.local not allowed -> $u"
          }
        } catch {
          $script:errors += "$($field): invalid URL -> $u"
        }
      }
    }

    foreach ($path in $files) {
      $obj = (Get-Content $path -Raw) | ConvertFrom-Yaml

      foreach ($k in @("orgname","app","env","displayname","apptype","servicenow_req")) {
        if (-not $obj.$k) { $errors += "$($path): missing required key '$k'" }
      }

      $snow = [string]$obj.servicenow_req
      if ($snow -and ($snow -notmatch '^REQ\d+$')) {
        $errors += "$($path): servicenow_req must match REQ<digits> (e.g., REQ0012345)"
      }

      Check-Urls $obj.callbacks "callbacks"
      Check-Urls $obj.logouturls "logouturls"
      Check-Urls $obj.allowedorigins "allowedorigins"

      $conns = @($obj.connections)
      $unknown = $conns | Where-Object { $_ -notin $allowedConns }
      if ($unknown.Count -gt 0) {
        $errors += "$($path): unsupported connections $($unknown -join ', '). Allowed: $($allowedConns -join ', ')"
      }
      if ($conns.Count -eq 0) {
        $errors += "$($path): 'connections' must include at least one of $($allowedConns -join ', ')"
      }
    }

    if ($errors.Count -gt 0) {
      Write-Host "VALIDATION FAILED:"
      $errors | ForEach-Object { Write-Host " - $_" }
      exit 1
    } else {
      Write-Host "Validation passed âœ…"
    }
